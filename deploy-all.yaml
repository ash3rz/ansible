---

- include: verify-PRE_DEPLOY.yaml

- include: TMP-services-cleanup.yaml

############################################
# Third-party
############################################
- include: infra-amqp-brokers.yaml
  when: not parasitic

- include: infra-deploy-irods-elasticsearch.yaml
  when: not parasitic

############################################
# Services Support
############################################
- include: playbooks/de-services-common.yml
- include: playbooks/de-systemd-de-target_down.yaml
- include: playbooks/infra-docker-cleanup.yaml

############################################
# Condor
############################################
- include: playbooks/infra-condor-exec-jar.yaml
- include: playbooks/de-porklock.yaml

############################################
# Databases
############################################
- include: db-migrations.yaml

############################################
# Services
############################################

- include: playbooks/de-iplant-data-cfg.yaml
- include: playbooks/de-jex.yaml
- include: playbooks/de-pull-images.yaml
- include: playbooks/de-stop-containers.yml
- include: playbooks/de-rm-containers.yml
- include: playbooks/de-start-containers.yml

############################################
# DE UI
############################################
- include: playbooks/de-ui.yaml

############################################
# Logging; ELK Stack
############################################
- include: support-elk-stack.yaml

- include: playbooks/support-rsyslog-config.yaml
- include: playbooks/support-logstash-forwarder.yaml

############################################
# Systems
############################################
- include: infra-systems.yaml
  vars:
    reboot: true

- include: playbooks/de-systemd-de-target_up.yaml

- include: verify-POST_DEPLOY.yaml
